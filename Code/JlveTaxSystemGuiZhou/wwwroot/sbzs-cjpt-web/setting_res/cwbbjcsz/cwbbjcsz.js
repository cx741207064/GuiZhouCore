﻿var zlbsxl = {
	"ZL1001001": "企业会计准则（一般企业）财务报表报送与信息采集",
	"ZL1001002": "企业会计制度财务报表报送与信息采集",
	"ZL1001003": "小企业会计准则财务报表与信息采集",
	"ZL1001010": "行业会计制度（运输[交通]）财务报表报送与信息采集",
	"ZL1001012": "企业会计制度（民航企业会计核算办法）财务报表报送与信息采集",
	"ZL1001015": "农民专业合作社财务会计制度财务报表报送与信息采集",
	"ZL1001016": "勘察设计企业会计制度财务报表报送与信息采集",
	"ZL1001017": "企业会计制度（保险中介公司会计核算办法）财务报表报送与信息采集",
	"ZL1001018": "企业会计准则（商业银行）财务报表报送与信息采集",
	"ZL1001019": "企业会计准则（证券公司）财务报表报送与信息采集",
	"ZL1001020": "企业会计准则（保险公司）财务报表报送与信息采集",
	"ZL1001021": "企业会计准则（典当企业）财务报表报送与信息采集",
	"ZL1001022": "企业会计准则（担保企业会计核算办法）财务报表报送与信息采集",
	"ZL1001023": "民间非营利组织会计制度财务报表报送与信息采集",
	"ZL1001024": "事业单位会计制度财务报表报送与信息采集",
	"ZL1001025": "中小学校会计制度财务报表报送与信息采集",
	"ZL1001026": "高等学校会计制度财务报表报送与信息采集",
	"ZL1001027": "医院会计制度财务报表报送与信息采集",
	"ZL1001028": "科学事业单位会计制度财务报表报送与信息采集",
	"ZL1001029": "测绘事业单位会计制度财务报表报送与信息采集",
	"ZL1002001": "个人股东变动情况报告",
	"ZL1002002": "个人所得税股权激励报告管理",
	"ZL1003001": "同期资料采集",
	"ZL1003002": "单边预约定价安排企业执行情况年度报告",
	"ZL1003003": "双边或多边预约定价安排企业执行情况年度报告",
	"ZL1003004": "单边预约定价安排企业执行情况实质性变化报告",
	"ZL1003005": "双边或多边预约定价安排企业执行情况实质性变化报告",
	"ZL1003006": "成本分摊协议备案",
	"ZL1004001": "减免收入数据采集",
	"ZL1004002": "税收资料调查企业数据采集",
	"ZL1004003": "企业集团数据采集",
	"ZL1005001": "重点税源监控企业数据采集",
	"ZL1006001": "非税控电子器具使用的软件程序说明资料备案",
	"ZL1007001": "土地出（转）让信息采集",
	"ZL1007002": "税源申报明细报告",
	"ZL1008001": "海上油气生产设施废弃处置方案备案",
	"ZL1009002": "非居民企业股权转让的资料采集",
	"ZL1010001": "软件产品增值税即征即退进项分摊方式资料报送与信息采集",
	"ZL1011001": "新牌号、新规格卷烟信息的资料采集",
	"ZL1001030": "文化事业单位会计制度财务报表报送与信息采集",
	"ZL1001031": "广播事业单位会计制度财务报表报送与信息采集",
	"ZL1001032": "体育事业单位会计制度财务报表报送与信息采集",
	"ZL1001033": "文物事业单位会计制度财务报表报送与信息采集",
	"ZL1001034": "人口和计划生育事业单位会计制度财务报表报送与信息采集",
	"ZL1001036": "银行类金融企业财务报表报送与信息采集",
	"ZL1001037": "证券类金融企业财务报表报送与信息采集",
	"ZL1001038": "保险类金融企业财务报表报送与信息采集",
	"ZL1001039": "担保类金融企业财务报表报送与信息采集",
	"ZL1001040": "金融控股集团公司类金融企业财务报表报送与信息采集",
	"ZL1001041": "金融资产管理公司类金融企业财务报表报送与信息采集",
	"ZL1011002": "消费税涉税信息采集",
	"ZL1011003": "消费税退（免）税资料报送与信息采集",
	"ZL1012001": "定点联系企业名册信息报送与采集",
	"ZL1014001": "欠税清缴计划信息采集",
	"ZL1013001": "耕地占用税税源明细信息采集",
	"ZL1001045": "企业集团合并财务报表报送与信息采集",
	"ZL1001042": "彩票机构会计制度财务报表报送与信息采集",
	"ZL1001043": "村集体经济组织财务报表报送与信息采集",
	"ZL1001044": "个体工商户财务报表报送与信息采集",
	"ZL1008002": "固定资产加速折旧(扣除)预缴情况统计",
	"ZL1001047": "基层医疗卫生机构会计制度财务报表资料报送与信息采集",
	"ZL1001046": "行政单位会计制度财务报表报送与信息采集"
};

var zlbsxlKjzdDz = {
	"ZL1001001": "101",
	"ZL1001018": "101",
	"ZL1001019": "101",
	"ZL1001020": "101",
	"ZL1001045": "101",
	"ZL1001003": "102",
	"ZL1001002": "201",
	"ZL1001036": "201",
	"ZL1001037": "201",
	"ZL1001038": "201",
	"ZL1001039": "201",
	"ZL1001040": "201",
	"ZL1001044": "215",
	"ZL1001024": "216",
	"ZL1001023": "222",
	"ZL1001015": "223",
	"ZL1001043": "224",
	"ZL1001041": "231",
	"ZL1001031": "103",
	"ZL1001031": "216",
	"ZL1001010": "211",
	"ZL1001028": "229",
	"ZL1001027": "221",
	"ZL1001025": "220",
	"ZL1001016": "206",
	"ZL1001026": "219",
	"ZL1001029": "218",
	"ZL1001030": "103",
	"ZL1001030": "216",
	"ZL1001032": "103",
	"ZL1001032": "216",
	"ZL1001034": "103",
	"ZL1001034": "216",
	"ZL1001042": "230",
	"ZL1001017": "204",
	"ZL1001047": "232",
	"ZL1001012": "268",
	"ZL1001033": "216",
	"ZL1001046": "227",
	"ZL1001022": "101",
	"ZL1001021": "101",
	"ZL1001024": "103"
};

var bjzlbsxlyjb = {
	"101": {
		"mc": "企业会计准则",
		"zlbsxl": {
			"ZL1001001": "企业会计准则（一般企业）财务报表报送与信息采集",
			"ZL1001018": "企业会计准则（商业银行）财务报表报送与信息采集",
			"ZL1001019": "企业会计准则（证券公司）财务报表报送与信息采集",
			"ZL1001020": "企业会计准则（保险公司）财务报表报送与信息采集",
			"ZL1001022": "企业会计准则（担保企业会计核算办法）财务报表报送与信息采集"
		}
	},
	"102": {
		"mc": "小企业会计准则",
		"zlbsxl": {
			"ZL1001003": "小企业会计准则财务报表与信息采集"
		}
	},
	"216": {
		"mc": "事业单位会计制度",
		"zlbsxl": {
			"ZL1001024": "事业单位会计制度财务报表报送与信息采集"
		}
	},
	"all": {
		"mc": "",
		"zlbsxl": {
			"ZL1001001": "企业会计准则（一般企业）财务报表报送与信息采集",
			"ZL1001003": "小企业会计准则财务报表与信息采集",
			"ZL1001018": "企业会计准则（商业银行）财务报表报送与信息采集",
			"ZL1001019": "企业会计准则（证券公司）财务报表报送与信息采集",
			"ZL1001020": "企业会计准则（保险公司）财务报表报送与信息采集",
			"ZL1001022": "企业会计准则（担保企业会计核算办法）财务报表报送与信息采集",
			"ZL1001024": "事业单位会计制度财务报表报送与信息采集",
			"ZL1001045": "企业集团合并财务报表报送与信息采集"
		}
	}
};
var ecdrcbxl = "ZL1001001,ZL1001003,ZL1001018,ZL1001019,ZL1001020,ZL1001022,ZL1001024";
var _startfrom = "";
/**
 * 表单框架执行时针对scope定制方法
 *
 * @param $scope
 * @returns $scope
 */
function scopeCallback($scope) {
	getzsxlDm($scope);
	_startfrom = "";
	$scope.nbnfCT = getnbnf();
	var swjgDm = $scope.formData.extraParam.djNsrxx.zgswjdm;
	if (swjgDm.indexOf('111') == 0
		 && ("03" == $scope.formData.cwbbbsjcsz.bsqj || "04" == $scope.formData.cwbbbsjcsz.bsqj)) { //月季报
		$scope["CT"]["zlbsCT"] = bjzlbsxlyjb;
	}
	//会计准则带出小类变量
	$scope.zlbsxlValue = $scope.formData.cwbbbsjcsz.cwkjzdzz;
	//防止cwkjzdzz2zlbsxl为空的情况，默认赋值Y
	if ($scope.formData.cwbbbsjcsz.cwkjzdzz2zlbsxl == "" || $scope.formData.cwbbbsjcsz.cwkjzdzz2zlbsxl == null || $scope.formData.cwbbbsjcsz.cwkjzdzz2zlbsxl == undefined) {
		$scope.formData.cwbbbsjcsz.cwkjzdzz2zlbsxl = "Y";
	}
	if ($scope.formData.cwbbbsjcsz.cwkjzdzz2zlbsxl == "N") {
		$scope.zlbsxlValue = "all";
	}
	//会计准则带出小类控制
	$scope.zlbsxlControl = function () {
		if ($scope.formData.cwbbbsjcsz.cwkjzdzz == "" || $scope.formData.cwbbbsjcsz.cwkjzdzz == "all") {
			$scope.zlbsxlValue = "";
		} else if ($scope.formData.cwbbbsjcsz.cwkjzdzz2zlbsxl == "Y") {
			$scope.zlbsxlValue = $scope.formData.cwbbbsjcsz.cwkjzdzz;
		} else if ($scope.formData.cwbbbsjcsz.cwkjzdzz2zlbsxl == "N") {
			$scope.zlbsxlValue = "all";
		}
		$scope.checkNullData();
	}
	//日期校验
	$scope.checkSsq = function (dynDatezbz) {
		var bsqj = $scope.formData.cwbbbsjcsz.bsqj;
		var sssqq = $scope.formData.cwbbbsjcsz.sssqq;
		var sssqz = $scope.formData.cwbbbsjcsz.sssqz;
		if (dynDatezbz) {
			var rtnSsq = changeSsq($scope, dynDatezbz, bsqj, sssqq, sssqz);
			if (rtnSsq.isTrue) {
				// 年报才赋值
				if(bsqj == "01"){
					$scope.formData.cwbbbsjcsz.nbnf = sssqq.split("-")[0];
				}
				sssqq = rtnSsq.sssqq;
				sssqz = rtnSsq.sssqz;
			}
		}
		var isTrue = checkDate(bsqj, sssqq, sssqz);
		if (isTrue || "true" == isTrue) {
			del_error("sbssq");
		} else {
			add_error("sbssq");
		}
		$scope.saveDate();
	}
	//年报日期校验
	$scope.changenbSsq = function () {
		//debugger;
		var nbssqq = $scope.formData.cwbbbsjcsz.nbsssqq;
		var nbssqz = $scope.formData.cwbbbsjcsz.nbsssqz;
		var isTrue = checkDate("01", nbssqq, nbssqz);
		if (isTrue || "true" == isTrue) {
			del_error("nbsbssq");
		} else {
			add_error("nbsbssq");
		}
		$scope.saveDate();
	}
	//属期保存到session
	$scope.saveDate = function () {

		var sssqq = $scope.formData.cwbbbsjcsz.sssqq;
		var sssqz = $scope.formData.cwbbbsjcsz.sssqz;
		var nbsssqq = $scope.formData.cwbbbsjcsz.nbnf + "-01-01";
		var nbsssqz = $scope.formData.cwbbbsjcsz.nbnf + "-12-31";
		var bsqj = $scope.formData.cwbbbsjcsz.bsqj;
		if ("01" == bsqj) {
			sssqq = nbsssqq;
			sssqz = nbsssqz;
		}
		var dateJson = {};
		dateJson.sssqq = sssqq;
		dateJson.sssqz = sssqz;
		dateJson.nbsssqq = nbsssqq;
		dateJson.nbsssqz = nbsssqz;
		$scope.formData.cwbbbsjcsz.sssqq = sssqq;
		$scope.formData.cwbbbsjcsz.sssqz = sssqz;
		$scope.formData.cwbbbsjcsz.nbsssqq = nbsssqq;
		$scope.formData.cwbbbsjcsz.nbsssqz = nbsssqz;
		//saveTimeData(dateJson);
		updateCwbbFormData($scope.formData);
	}
	//校验空值数据
	$scope.checkNullData = function () {
		var cwkjzdzz = $scope.formData.cwbbbsjcsz.cwkjzdzz;
		var zlbsxl = $scope.formData.cwbbbsjcsz.zlbsxl;
		var bsqj = $scope.formData.cwbbbsjcsz.bsqj;
		var sssqq = $scope.formData.cwbbbsjcsz.sssqq;
		var sssqz = $scope.formData.cwbbbsjcsz.sssqz;
		var datArr = checkFormDate(cwkjzdzz, zlbsxl, bsqj, sssqq, sssqz);
		if (datArr[0] == "false") {
			for (var i = 0; i < datArr.length; i++) {
				del_error(datArr[i]);
			}
		} else {
			for (var i = 0; i < datArr.length; i++) {
				add_error(datArr[i]);
			}
		}
		var bzz = $('#bzz', window.parent.document).val();
		if ("csgj" == bzz) {
			//财税管家版本，小企业和一般企业，可以获取外部数据，其他小类默认为手工填写
			if (("ZL1001001" == zlbsxl && "101" == cwkjzdzz) || ("ZL1001003" == zlbsxl && "102" == cwkjzdzz) || ("ZL1001002" == zlbsxl && "201" == cwkjzdzz)) {
				$("input[name='wjckrj']").each(function () {
					$(this).attr("disabled", false);
				});
			}else{
				$scope.formData.cwbbbsjcsz.wjckrj = "";
				$("#wjckrj_sgtb").click(); //默认选中手工填报
				$("input[name='wjckrj']").each(function () {
					$(this).attr("disabled", true);
				});
			}
			//excel财报导入没有实现企业会计制度
			var wjckrj = getQueryString("wjckrj");
			if("qgbecdrcb" == wjckrj && ("ZL1001002" == zlbsxl && "201" == cwkjzdzz)){
				$('#qgbecdrcbChk').attr("disabled", true);
				 if ($('#qgbecdrcbChk').attr("checked")){
					 $("#wjckrj_sgtb").click(); //默认选中手工填报
				 }
			}
			$('#wjckrj_sgtb').attr("disabled", false); //手工填报修改为可以选择
			$('#zhwbxtChk').attr("disabled", false);
			if (ecdrcbxl.indexOf(zlbsxl) >= 0) {
				$('#ecdrcbChk').attr("disabled", false);
				$('#qgbecdrcbChk').attr("disabled", false);
			}
		}
		$scope.checkSsq();
	}
	//报送期间带出上期属期
	$scope.bsqjToSsq = function () {
		var bsqj = $scope.formData.cwbbbsjcsz.bsqj;
		var reJson = bsqjForSsq(bsqj);
		$scope.formData.cwbbbsjcsz.sssqq = reJson.sssqq;
		$scope.formData.cwbbbsjcsz.sssqz = reJson.sssqz;
		var bzz = $('#bzz', window.parent.document).val();
		if ("csgj" == bzz) {
			if ("01" == bsqj) {
				$scope.formData.cwbbbsjcsz.nbsssqq = reJson.sssqq;
				$scope.formData.cwbbbsjcsz.nbsssqz = reJson.sssqz;
				$('#sbssqTrId').hide();
				$('#nbsbssqTrId').show();
			} else {
				$('#sbssqTrId').show();
				$('#nbsbssqTrId').hide();
			}
		}
		getDzbd($scope.formData.cwbbbsjcsz.zlbsxlDm);
		$scope.checkSsq();
		$scope.saveDate();
	}

	$scope.changeZlbsxl = function (zlbsxlDm) {
		$scope.formData.cwbbbsjcsz.zlbsxl = zlbsxlDm;
		$scope.formData.cwbbbsjcsz.zlbsxlDm = zlbsxlDm;
		var num = $scope.formData.cwbbbsjcsz.bblx == '0' ? $('#zlbsxlYJNum').val() : $('#zlbsxlNDNum').val();
		if ("N" != $scope.formData.isCwbabz && zlbsxlDm == 'ZL1001045') {
			$('#bblx1').css('display', 'none');
			$('#radio2').attr('checked', true);
			$('#bblx2').css('margin-left', '0px');
			//SDSDSYHB-1427:集团合并财务报表业务逻辑上并不需要备案，以清册传过来的属期显示，不强制按年申报
			//$scope.formData.cwbbbsjcsz.bblx='1';
		} else {
			$('#bblx1').css('display', 'block');
			$('#bblx2').css('margin-left', '72px');
		}
		if ($scope.formData.cwbbbsjcsz.bblx == '0') {
			$("#yjbTr1,#yjbTr2").show();
			$("#nbTr1").hide();
		} else {
			$("#yjbTr1,#yjbTr2").hide();
			$("#nbTr1").show();
		}

		if (num > 1) {
			$('#zlbsxlDm').attr('disabled', false);
		} else if ((zlbsxlDm == "" || zlbsxlDm == null || zlbsxlDm == undefined) && num > 0) {
			$('#zlbsxlDm').attr('disabled', false);
		} else {
			$('#zlbsxlDm').attr('disabled', true);
		}
		if ('N' == $scope.formData.isCwbabz && (zlbsxlDm != '' && zlbsxlDm != null && zlbsxlDm != undefined)) {
			$scope.formData.cwbbbsjcsz.cwkjzdzz = zlbsxlKjzdDz[zlbsxlDm];
			$scope.formData.cwbbbsjcsz.kjzdzzDm = zlbsxlKjzdDz[zlbsxlDm];
		}
		if (zlbsxlDm == 'ZL1001045') {
			var swjgDm = $('#swjgDm', window.parent.document).val();
			var cwkjzdzzDm = $scope.formData.cwbbbsjcsz.kjzdzzDm;
			if ((swjgDm.indexOf('121') == 0 || swjgDm.indexOf('221') == 0) && (cwkjzdzzDm == "" || cwkjzdzzDm == null || cwkjzdzzDm == undefined)) {
				$scope.formData.cwbbbsjcsz.cwkjzdzz = zlbsxlKjzdDz[zlbsxlDm];
				$scope.formData.cwbbbsjcsz.kjzdzzDm = zlbsxlKjzdDz[zlbsxlDm];
			}
		}
		updateCwbbFormData($scope.formData);
		getDzbd(zlbsxlDm);
		startfrom();
		$scope.$apply();
	}
	$scope.changeBblx = function (bblx) {
		var num = bblx == '0' ? $('#zlbsxlYJNum').val() : $('#zlbsxlNDNum').val();
		if (bblx == '0') {
			$scope["CT"]["zlbsxlCT"] = JSON.parse($('#zlbsxlYJCT').val());
		} else {
			$scope["CT"]["zlbsxlCT"] = JSON.parse($('#zlbsxlNDCT').val());
		}
		if (num > 1) {
			$('#zlbsxlDm').attr('disabled', false);
		} else {
			$('#zlbsxlDm').attr('disabled', true);
		}
		$scope.$apply();
	}
	return $scope;
}

/**
 * 初始化页面回调
 */
function initCallback() {
	var frmDataStr = $('#formDataSpan').html();
	var jsonData = JSON.parse(frmDataStr);
	var url = parent.location.href;
	if (parent.formData != "" && url.indexOf("sjlybz=01") > -1) {
		parent.layer.alert("获取局端数据成功。",{title:"提示",icon: 1});
	}
	var swjgDm = jsonData.extraParam.djNsrxx.zgswjdm;
	var bzz = $('#bzz', window.parent.document).val();

	if ((swjgDm.indexOf('137') == 0 || swjgDm.indexOf('151') == 0) && "csgj" == bzz) {
		if (swjgDm.indexOf('13702') == 0) { //2018-04-19青岛不执行下面的方法

		} else {
			//财税管家山东国税个性化
			var zlbsxlDm = $('#zlbsxlDm').val();
			var cwkjzdzzDm = $('#cwkjzdzzDm').val();
			var bsqjId = $('#bsqjId').val();

			if (zlbsxlDm != null && zlbsxlDm != "" && zlbsxlDm != undefined && zlbsxlDm != "undefined") {
				$('#zlbsxlDm').attr('disabled', true);
			} else {
				$('#cwbbchssj', window.parent.document).click();
			}
			if (cwkjzdzzDm != null && cwkjzdzzDm != "") {
				$('#cwkjzdzzDm').attr('disabled', true);
			}
			if (bsqjId != null && bsqjId != "") {
				$('#bsqjId').attr('disabled', true);
			}
			$(".input-btbz").show();
		}
	}
	if ("csgj" == bzz) {
		if (url.indexOf("sssqQ=2") == -1) {
			//财税管家版本，如果URL没有属期，则基础设置页中，显示属期
			$('#bsqjTrId').show();
			var bsqj = jsonData.cwbbbsjcsz.bsqj;
			if ("01" == bsqj) {
				$('#sbssqTrId').hide();
				$('#nbsbssqTrId').show();
			} else {
				$('#sbssqTrId').show();
				$('#nbsbssqTrId').hide();
			}

		}
		$('#iframehtm', window.parent.document).attr("height", $(document).height());
		//财税管家版本，小企业和一般企业，可以获取外部数据，其他小类默认为手工填写
		var zlbsxlDm = $('#zlbsxlDm').val();
		var cwkjzdzzDm = $('#cwkjzdzzDm').val();
		if (("ZL1001001" == zlbsxlDm && "101" == cwkjzdzzDm) || ("ZL1001003" == zlbsxlDm && "102" == cwkjzdzzDm) || ("ZL1001002" == zlbsxlDm && "201" == cwkjzdzzDm)) {
			$("input[name='wjckrj']").each(function () {
				$(this).attr("disabled", false);
			});
		}else {
			//$("#wjckrj_sgtb").click();
			$("input[name='wjckrj']").each(function () {
				$(this).attr("disabled", true);
			});
		}
		//excel财报导入没有实现企业会计制度
		var wjckrj = getQueryString("wjckrj");
		var chechedWjckrj = $("input[name='wjckrj']:checked").val();
		if("qgbecdrcb" == chechedWjckrj && ("ZL1001002" == zlbsxlDm && "201" == cwkjzdzzDm)){
			$('#qgbecdrcbChk').attr("disabled", true);
			$("#wjckrj_sgtb").click();
		} 
		$('#zhwbxtChk').attr("disabled", false);
		//2018-02-25 CSGJ-1355	【2.1版生产环境】财务报表为年报申报时，报表基础设置的“财务报表数据获取方式”要隐藏‘畅捷通-好会计’
		var bsqj = jsonData.cwbbbsjcsz.bsqj;
		if ("01" == bsqj) {
			$('#cjthkjTrId').hide();
		} else {
			$('#cjthkjTrId').show();
		}
		var isznzh = getQueryString("isznzh");
		if ("Y" == isznzh) {
			$('#cjthkjTrId').hide();
			$('#zhwbxtTrId').show();
		} else {
			$('#zhwbxtTrId').hide();
		}
		
		if ("ecdrcb" == wjckrj) {
			$('#ecdrcbTrId').show();
		}else if ("qgbecdrcb" == wjckrj) {
			$('#qgbecdrcbTrId').show();
		}
		$('#wjckrj_sgtb').attr("disabled", false); //手工填报修改为可以选择
		if (ecdrcbxl.indexOf(zlbsxlDm) >= 0) {
			$('#ecdrcbChk').attr("disabled", false);
			$('#qgbecdrcbChk').attr("disabled", false);
		}
		/*var tmpextraParam = parent.formData.extraParam;
		if(tmpextraParam!=null &&  tmpextraParam !=undefined){
		var drexcelurl = parent.formData.extraParam.drexcelurl;
		if(drexcelurl!=null && drexcelurl!=""){
		$('#ecdrcbTrId').show();
		}
		}*/
		if (swjgDm.indexOf('13702') == 0) { //2018-05-30、BSZS-1063【青岛助手预生产】财务报表跳转的财税管家页面中应不允许选择财务制度准则
			$('#zlbsxlDm').attr('disabled', true);
			$('#cwkjzdzzDm').attr('disabled', true);
			/*if (formData.cwbbbsjcsz.zlbsxl == "" || formData.cwbbbsjcsz.cwkjzdzz == ""){
			parent.Message.succeedInfo({
			title : "提示",
			message : "系统检测您没有备案财务会计制度准则，请与当地税局确认。",
			handler : function() {

			}
			});
			parent.$("#save").attr('disabled',true);
			}*/
		}
		//if ((swjgDm.indexOf('111') != -1 || swjgDm.indexOf('211') != -1) && "csgj" == bzz) {
		//2018-07-03根据CSGJ-1628财务报表，基础设置选项里，隐藏好会计选项。 
			$('#cjthkjTrId').hide();
		//}
	} else {
		parent.autoResizeIframe("iframehtm");
		$('#zhwbxtTrId').hide();
	}
	var isycbdtz = getQueryString("isycbdtz");
	if ("Y" == isycbdtz) {
		$('#bdcwrjTrId').hide();
	} else {
		$('#bdcwrjTrId').show();
	}
	parent.$("#save").unbind("click");
	parent.$("#save").on("click", saveEvent1);
	parent.$("#save").attr('class', 'btn btn10');
	startfrom();
};

function startfrom() {
	if (_startfrom == "dlgswba") {
		//$('#cwbbfb').hide();
		$('#kjzdzzh').hide();
		$('#yjbTr1').hide();
		$('#yjbTr2').hide();
		$('#nbTr1').hide();
		var swjgDm = parent.formData.extraParam.djNsrxx.zgswjdm;
		if (swjgDm.indexOf("121") == 0 || swjgDm.indexOf("221") == 0) {
			var bzz = $('#bzz', window.parent.document).val();
			if ("csgj" == bzz) { //大连财税管家不进行校验

			} else {
				var url = parent.location.href;
				if (url.charAt(url.length - 1) == '#') { //抹除#号
					url = url.substr(0, url.length - 1);
				}
				var isCwbabz = "N";
				var isCwbabzIndex = url.indexOf("isCwbabz=");
				var kjzdzzDm = "";
				var kjzdzzDmIndex = url.indexOf("kjzdzzDm=");
				var zlbsxlDm = "";
				var zlbsxlDmIndex = url.indexOf("zlbsxlDm=");
				if (zlbsxlDmIndex != -1) {
					if (url.indexOf("&", zlbsxlDmIndex) != -1) {
						zlbsxlDm = url.substring(zlbsxlDmIndex + "zlbsxlDm=".length, url.indexOf("&", zlbsxlDmIndex));
					} else {
						zlbsxlDm = url.substring(zlbsxlDmIndex + "zlbsxlDm=".length);
					}
				}
				if (isCwbabzIndex != -1) {
					if (url.indexOf("&", isCwbabzIndex) != -1) {
						isCwbabz = url.substring(isCwbabzIndex + "isCwbabz=".length, url.indexOf("&", isCwbabzIndex));
					} else {
						isCwbabz = url.substring(isCwbabzIndex + "isCwbabz=".length);
					}
				}
				if (kjzdzzDmIndex != -1) {
					if (url.indexOf("&", kjzdzzDmIndex) != -1) {
						kjzdzzDm = url.substring(kjzdzzDmIndex + "kjzdzzDm=".length, url.indexOf("&", kjzdzzDmIndex));
					} else {
						kjzdzzDm = url.substring(kjzdzzDmIndex + "kjzdzzDm=".length);
					}
				}
				//未备案，未传送会计准则代码和会计小类的情况下，允许选择属期
				if ("N" == isCwbabz && ("" == kjzdzzDm || "null" == kjzdzzDm || kjzdzzDm == null || kjzdzzDm == undefined) && ("" == zlbsxlDm || "null" == zlbsxlDm || zlbsxlDm == null || zlbsxlDm == undefined)) {
					//$('#yjbTr1').show();
					$('#yjbTr2').show();
					$('#sssqqId').attr('disabled', true);
					$('#sssqzId').attr('disabled', true);
				}

			}
		}
	}
}

/**
 * 财务报表下一步 修改为先校验是否逾期申报，后执行下一步
 * @returns {Boolean}
 */
function saveEvent2() {
	var swjgDm = parent.formData.extraParam.djNsrxx.zgswjdm;
	if (typeof parent.validateBeforeSubmit == "function") {
		var rtnFlag = false;
		if (!parent.validateBeforeSubmit()) {
			if (parent.$("#ywbm").val().toLowerCase().indexOf("cwbb") > -1) {
				rtnFlag = true;
			} else {
				return false;
			}
		}
		if (rtnFlag) {
			return;
		}

		var dzbd = getSelectDzbd();
		if ((swjgDm.indexOf("121") == 0 || swjgDm.indexOf("221") == 0) && (dzbd == undefined || dzbd == "" || dzbd.length == 0)) {
			var bzz = $('#bzz', window.parent.document).val();
			if ("csgj" == bzz) { //大连财税管家不进行校验

			} else {
				parent.layer.alert("请选择要报送的报表!",{title:"错误",icon: 2});
				return;
			}
		}
	}
	var drowMap = {};
	var dzbd = getSelectDzbd();
	var formData = parent.$("#iframehtm").contents().find('#formDataSpan').html();
	if (dzbd != '' && dzbd != undefined) {
		formData = formData.replace('"cwbbbsjcsz":{', '"cwbbbsjcsz":{"dzbd":"' + dzbd + '",')
	}
	var sssqQ = "";
	var sssqZ = "";
	if (formData != null && formData != "" && parent.$("#ywbm").val().match("CWBB")) {
		var cwbbbsjcsz = jQuery.parseJSON(formData).cwbbbsjcsz;
		if (cwbbbsjcsz != null) {
			sssqQ = cwbbbsjcsz.sssqq;
			sssqZ = cwbbbsjcsz.sssqz;
		}
	}
	if (sssqQ == null || sssqQ == "") {
		sssqQ = parent.$("#sssqQ").val();
	}
	if (sssqZ == null || sssqZ == "") {
		sssqZ = parent.$("#sssqZ").val();
	}
	var djxh = parent.formData.extraParam.djNsrxx.djxh;
	var nsrsbh = parent.formData.extraParam.djNsrxx.nsrsbh;
	parent.$("body").mask("正在保存数据，请稍候...");
	$.ajax({
		type: "POST",
		url: parent.cp + "/setting/saveData.do?djxh=" + djxh + "&ywbm=" + parent.$("#ywbm").val() + "&sssqQ=" + sssqQ + "&sssqZ=" + sssqZ + "&gdslxDm=" + parent.$("#gdslxDm").val() + "&test=" + parent.$("#test").val() + "&nsrsbh=" + nsrsbh + "&swjgDm=" + swjgDm,
		dataType: "json",
		contentType: "application/json",
		data: JSON.stringify(formData),
		success: function (data) {
			parent.$("body").unmask();
			var jsondata = jQuery.parseJSON(data);
			if ("Y" == jsondata.returnFlag) {
				var msg = jsondata.warnInfo?jsondata.warnInfo=="CFSB"?"CFSB":jsondata.warnInfo.msg : false;
				if("CFSB" == msg){
					//判断是否在清册有提示过
					var cfsbBz = getQueryString("cfsbBz");
					if(cfsbBz==null || cfsbBz==undefined || "Y"!=cfsbBz){
						//重复申报提示
						parent.layer.confirm('<br/>&nbsp;&nbsp;&nbsp;&nbsp;您本期已报送该报表，是否进行更正？&nbsp;&nbsp;&nbsp;&nbsp;<br/><br/>', {
								title:'提示',
								btn : ['确认', '取消']
							}, function(index){
								if (typeof parent.saveDataCallback == 'function') {
									parent.saveDataCallback(data);
								}
							}, function(index){
								//关闭当前页面
								parent.window.opener=null;
								parent.window.open('','_self');
								parent.window.close();
					    	}
						);
					}else{
						//已经在清册提示过，则执行后面的保存，跳转到申报页
						if (typeof parent.saveDataCallback == 'function') {
							parent.saveDataCallback(data);
						}
					}
				}else if (msg) {
					parent.layer.confirm(msg,{
						title: "提示",
						btn : ['确定'],
						icon: 1
					},function(index){
						parent.layer.close(index);
						if (typeof parent.saveDataCallback == 'function') {
							saveDataCallback(data);
						}
					});
				} else {
					if (typeof parent.saveDataCallback == 'function') {
						parent.saveDataCallback(data);
					}
				}
			} else if ("N" == jsondata.djxhIsSame) {
				parent.layer.confirm("尊敬的纳税人：G000000表中纳税人信息与当前登录纳税人信息不一致，请点击【确定】刷新页面！",{
 					title:'错误',
 					btn : ['确定'],
 					icon: 1
 				},function(index){
 					parent.layer.close(index);
 					var url = window.location.href;
					if (url.indexOf("sjlybz=01") > -1) {
						window.location.reload();
					} else {
						if (url.indexOf("sjlybz") > -1) {
							var pre = url.substr(0, url.indexOf("sjlybz"));
							var andIndex = url.indexOf("&", url.indexOf("sjlybz"));
							var end = "";
							if (andIndex > -1) {
								end = url.substr(andIndex);
							} else {
								end = "";
							}
							url = pre + "sjlybz=01" + end;
							window.location.href = url;
						} else {
							if (url.lastIndexOf("#") > -1) {
								url = url.substr(0, url.length - 1) + "&sjlybz=01#";
							} else {
								url = url + "&sjlybz=01";
							}
							window.location.href = url;
						}

					}
 				});
			} else {
				if (jsondata.errInfo) {
					if (jsondata.errInfo.code == "111") {
						parent.layer.alert("财务会计制度准则与资料报送小类不匹配！",{title:"错误",icon: 2});
					} else if (jsondata.errInfo.code == "101") {
						parent.layer.alert("数据有误或空值！",{title:"错误",icon: 2});
					} else if (jsondata.errInfo.code == "100") {
						parent.layer.alert("报送期间与属期不匹配！",{title:"错误",icon: 2});
					} else {
						var msg = jsondata.errInfo.msg;
						parent.layer.alert(msg,{title:"错误",icon: 2});
					}
					parent.$("body").unmask();
				} else {
					parent.layer.alert("保存失败，未知原因。",{title:"错误",icon: 2});
				}
			}

		},
		error: function () {
			parent.$("body").unmask();
			parent.layer.alert("保存失败，请稍侯再试。",{title:"错误",icon: 2});
		}
	});
};
/**
 * 保存之前调用
 */
parent.validateBeforeSubmit = function () {
	//	debugger;
	//var scope = angular.element("#viewCtrlId").scope();
	var swjgDm = parent.formData.extraParam.djNsrxx.zgswjdm;
	if (swjgDm.indexOf('111') == 0) { //北京国税
		var tmpzlbsxlDm = $('#zlbsxlDm').val(); //防止从年报切换到月季报的情况
		if (tmpzlbsxlDm == null || tmpzlbsxlDm == undefined || tmpzlbsxlDm == "" || tmpzlbsxlDm == "undefined") {
			formData.cwbbbsjcsz.zlbsxl = "";
		}
	}
	updateCwbbFormData(formData); //更新最新的数据到formDataSpan中
	var frmDataStr = $('#formDataSpan').html();
	var frmData = JSON.parse(frmDataStr);
	var bsqj = frmData.cwbbbsjcsz.bsqj;
	var sssqq = frmData.cwbbbsjcsz.sssqq;
	var sssqz = frmData.cwbbbsjcsz.sssqz;
	var nbssqq = frmData.cwbbbsjcsz.nbsssqq;
	var nbssqz = frmData.cwbbbsjcsz.nbsssqz;
	var zlbsxl = frmData.cwbbbsjcsz.zlbsxl;
	var datArr = checkFormDate(cwkjzdzz, zlbsxl, bsqj, sssqq, sssqz);
	var isTrue = checkDate(bsqj, sssqq, sssqz);
	var nbIsTrue = true;
	if (nbssqq != null && nbssqq.length != 0 && nbssqz != null && nbssqz.length != 0) {
		isTrue = (isTrue && checkDate("01", nbssqq, nbssqz));
	}
	if (datArr[0] != "false") {
		isTrue = false
	}

	if (parent.$("#ywbm").val().toLowerCase().indexOf("cwbb") > -1) {
		if (datArr[0] == "zlbsxl") {
			rtnFlag = true;
			parent.layer.alert("请选择正确的资料报送小类!",{title:"错误",icon: 2});
		}
		if (datArr[0] == "bsqj") {
			rtnFlag = true;
			parent.layer.alert("请选择正确的报送期间!",{title:"错误",icon: 2});
		}
		if (datArr[0] == "sbssq") {
			rtnFlag = true;
			parent.layer.alert("请选择正确的报送期!",{title:"错误",icon: 2});
		}
	}

	return isTrue;
}
/**
 * 保存之后调用
 */
parent.saveDataCallback = function (data) {
	var infoData = jQuery.parseJSON(data);
	var formData = jQuery.parseJSON(infoData.body);
	var bzz = $('#bzz', window.parent.document).val();
	var url = parent.location.href;
	var wjckrj = formData.cwbbbsjcsz.wjckrj;
	var isFinaljh = false;
	if (url.charAt(url.length - 1) == "#") { //如果最后有#号则去掉最后的符号
		isFinaljh = true;
		url = url.substring(0, url.length - 1);
	}
	var msg = infoData.warnInfo?infoData.warnInfo=="CFSB"?"CFSB":infoData.warnInfo.msg : false;
	if("CFSB"==msg){
		//重复申报时，增加参数cfsbBz
		if (url.indexOf("cfsbBz") == -1) {
			url += "&cfsbBz=Y";
		} else {
			url = changeUrlArg(url, "cfsbBz", "Y");
		}
	}
	if ("csgj" == bzz) {
		var isznzh = getQueryString("isznzh");
		if ("Y" == isznzh) { //智能转换工具跳转本地套帐和智能转换工具
			if ("zhwbxt" == wjckrj) { //智能转换
				var tmpSssqq = formData.cwbbbsjcsz.sssqq.replace("-", "");
				tmpSssqq = tmpSssqq.substring(0, 6);
				var appParam = {
					"appid": "111",
					"appName": "NotifyCallCwbbXlsDr",
					"appParam": {
						"type": "2",
						"cwkjzdzz": formData.cwbbbsjcsz.cwkjzdzz,
						"zlbsxl": formData.cwbbbsjcsz.zlbsxl,
						"bsqj": formData.cwbbbsjcsz.bsqj,
						"bsq": tmpSssqq
					}
				};
				try {
					appParam = JSON.stringify(appParam);
					console.log("传给容器框的参数：" + appParam);
					var result = _omni.container.sendmessagetocontainer(appParam);
					console.log("容器框返回：" + result);

				} catch (f) {
					parent.layer.alert("启动智能转换工具失败！",{title:"错误",icon: 2});
				}
				return;
			}
		}
		//财税管家保存之后，手动填报财务报表，在设置报表基础信息后直接跳转财务报表填写页面，自动填报财务报表，在设置报表基础信息后直接跳转账套设置页面
		if ("bdcwrj" == wjckrj) {
			var ycsurl = getQueryString("ycsurl");
			if (ycsurl != null && ycsurl != "") {
				//对URL进行解码(通过encodeURIComponent将URL进行编码，传入参数,获取到的ycsurl是编码过的) 需要decode两次确保传输的url正常
				ycsurl = decodeURIComponent(ycsurl);
				//ycsurl = decodeURIComponent(ycsurl);
				parent.location.href = encodeURI(ycsurl);
			}
			return;
		}else if ("ecdrcb" == wjckrj) {
			var drexcelurl = parent.formData.extraParam.drexcelurl;
			if (drexcelurl != null && drexcelurl != "") {

				//http://bjgscsgj.jchl.com/web-bsgj/oauth2/authorize2.do?client_id=bjgs_cwsjdr&response_type=code&scope=snsapi_userinfo&state=123& secret= bjgs_cwsjdr&nsrsbh=
				//var mainUrl = window.location.protocol+'//'+window.location.host  ;
				var reqParamsObj = {};
				var reqParamsObjStr = JSON.stringify(reqParamsObj);
				//取url中的参数
				var client_id = parent.formData.extraParam.clientId;
				var state = getQueryString("state");
				var secret = parent.formData.extraParam.secret;
				var nsrsbh = parent.formData.extraParam.djNsrxx.nsrsbh;
				var serverurl = parent.formData.extraParam.serverurl; //  http://bjgscsgj.jchl.com/web-bsgj
				var oauth2url = serverurl + "/oauth2/authorize2.do?client_id=" + client_id + "&response_type=code&scope=snsapi_userinfo&state=" + state + "&secret=" + secret + "&nsrsbh=" + nsrsbh;
				$.ajax({
					url: oauth2url,
					type: "GET",
					data: {
						reqParamsJSON: reqParamsObjStr
					},
					dataType: "json",
					contentType: "application/json",
					success: function (redata) {
						if (redata != "" && redata != null && redata != undefined) {
							//取值
							var code = redata.code;
							if (code != "" && code != null && code != undefined) {
								//拼接参数
								var gdslxDm = $('#gdslxDm', window.parent.document).val();
								var kjzdzzDm = parent.formData.cwbbbsjcsz.cwkjzdzz;
								var zlbsxlDm = parent.formData.cwbbbsjcsz.zlbsxl;
								var bsqj = parent.formData.cwbbbsjcsz.bsqj;
								var sssqQ;
								var sssqZ;
								if ("01" == bsqj) { //年报
									sssqQ = parent.formData.cwbbbsjcsz.nbsssqq;
									sssqZ = parent.formData.cwbbbsjcsz.nbsssqz;
								} else {
									sssqQ = parent.formData.cwbbbsjcsz.sssqq;
									sssqZ = parent.formData.cwbbbsjcsz.sssqz;
								}
								var nsrsbh = nsrsbh;
								var djxh = parent.formData.extraParam.djNsrxx.djxh;
								var nsrmc = parent.formData.extraParam.djNsrxx.nsrmc;
								var zgswskfjDm = parent.formData.extraParam.djNsrxx.zgswjdm;
								drexcelurl = drexcelurl + "gdslxDm=" + gdslxDm + "&kjzdzzDm=" + kjzdzzDm + "&zlbsxlDm=" + zlbsxlDm + "&bbbsqDm=" + bsqj + "&sssqQ=" + sssqQ + "&sssqZ=" + sssqZ + "&nsrsbh=" + nsrsbh + "&djxh=" + djxh + "&nsrmc=" + nsrmc + "&zgswskfjDm=" + zgswskfjDm + "&tmp_code=" + code;
								parent.location.href = drexcelurl;
							} else {
								var errmsg = redata.errmsg;
								if (isEmpty(errmsg)) {
									errmsg = "未获取到授权码，无法跳转到Excel导入财报页面！";
								}
								parent.layer.alert(errmsg,{title:"错误",icon: 2});
							}
						} else {
							parent.layer.alert("未获取到授权码，无法跳转到Excel导入财报页面！",{title:"错误",icon: 2});
						}
					},
					error: function () {
						parent.layer.alert("链接超时或网络异常！",{title:"错误",icon: 2});
					},
					complete: function () {}
				});

			} else {
				parent.layer.alert("无法跳转到Excel导入财报页面！",{title:"错误",icon: 2});
			}
			return;
		}else if("qgbecdrcb" == wjckrj){
				var tmpSssqq = formData.cwbbbsjcsz.sssqq.replace("-", "");
				tmpSssqq = tmpSssqq.substring(0, 6);
				var gdslxDm = $('#gdslxDm', window.parent.document).val();
				var kjzdzzDm = parent.formData.cwbbbsjcsz.cwkjzdzz;
				var zlbsxlDm = parent.formData.cwbbbsjcsz.zlbsxl;
				var bbbsqDm = parent.formData.cwbbbsjcsz.bsqj;
				var sssqQ;
				var sssqZ;
				if ("01" == bbbsqDm) { //年报
					sssqQ = parent.formData.cwbbbsjcsz.nbsssqq;
					sssqZ = parent.formData.cwbbbsjcsz.nbsssqz;
				} else {
					sssqQ = parent.formData.cwbbbsjcsz.sssqq;
					sssqZ = parent.formData.cwbbbsjcsz.sssqz;
				}
				var nsrsbh = parent.formData.extraParam.djNsrxx.nsrsbh;
				var djxh = parent.formData.extraParam.djNsrxx.djxh;
				var nsrmc = parent.formData.extraParam.djNsrxx.nsrmc;
				var zgswskfjDm = parent.formData.extraParam.djNsrxx.zgswjdm;
				var appParam = {
					"appid": "111",
					"appName": "NotifyCallCwbbXlsDr",
					"appParam": {
						"type": "2",
						"gdslxDm": gdslxDm,
						"kjzdzzDm": kjzdzzDm,
						"zlbsxlDm": zlbsxlDm,
						"bbbsqDm": bbbsqDm,
						"sssqQ": sssqQ,
						"sssqZ": sssqZ,
						"nsrsbh": nsrsbh,
						"djxh": djxh,
						"nsrmc": nsrmc,
						"nsrsbh": nsrsbh,
						"zgswskfjDm": zgswskfjDm
					}
				};
				try {
					appParam = JSON.stringify(appParam);
					console.log("传给容器框的参数：" + appParam);
					var result = _omni.container.sendmessagetocontainer(appParam);
					console.log("容器框返回：" + result);

				} catch (f) {
					parent.layer.alert("启动Excel导入财报失败！",{title:"错误",icon: 2});
				}
				return;
			
		}
		var ycsurl = getQueryString("ycsurl");
		if (ycsurl != null && ycsurl != "") {
			var startIndex = url.indexOf("ycsurl=");
			var endIndex = url.indexOf("&", startIndex) + 1;
			url = url.substring(0, startIndex) + url.substring(endIndex);
		}
		//如果选择了畅捷通-好会计则需要传入特定参数
		if ("cjthkj" == wjckrj) {
			// &period=201712&type=balancesheet%2Cincome%2Ccash&bsqj=03&sbywbm=CWBB_XQY_KJZZ
			if (url.indexOf("period") == -1) {
				var tmpSssqz = formData.cwbbbsjcsz.sssqz.replace("-", "");
				tmpSssqz = tmpSssqz.substring(0, 6);
				url += "&period=" + tmpSssqz;
			}
			if (url.indexOf("type") == -1) {
				var tmpStr = "balancesheet%2Cincome%2Ccash";
				url += "&type=" + tmpStr;
			}
			if (url.indexOf("bsqj") == -1) {
				var tmpStr = formData.cwbbbsjcsz.bsqj;
				url += "&bsqj=" + tmpStr;
			}
			if (url.indexOf("sbywbm") == -1) {
				var tmpStr = formData.cwbbbsjcsz.sbywbm.toUpperCase();
				url += "&sbywbm=" + tmpStr;
			}
		}

	}

	var dzbd = getSelectDzbd();
	var cwbbjcszym = $("#cwbbjcszym").val();
	if (cwbbjcszym != null && "cwbbydy" == cwbbjcszym) {
		var cwbbbsjcszData = formData.cwbbbsjcsz;
		var sbywbm = cwbbbsjcszData.sbywbm.toUpperCase();
		if (sbywbm == null || sbywbm == undefined || sbywbm == "" || sbywbm == "undefined") {
			parent.window.location.href = url;
		}
		var cwbbbm = getCwbbbm(sbywbm);
		var swjgDm = parent.formData.extraParam.djNsrxx.zgswjdm;
		if (swjgDm.indexOf("121") == 0 || swjgDm.indexOf("221") == 0) {
			url = url.replace("cwbbydydl", cwbbbsjcszData.sbywbm.toLowerCase()).replace("setting", cwbbbm);
			if (url.charAt(url.length - 1) == "#") {
				url = url.replace("#", "&xzdzbd=" + dzbd + "#");
			} else {
				url = url + "&xzdzbd=" + dzbd;
			}
		} else {
			url = url.replace("cwbbydy", cwbbbsjcszData.sbywbm.toLowerCase()).replace("setting", cwbbbm);
		}
		if (cwbbbsjcszData.bblx == '1') {
			if (url.indexOf("bbbsq_dm") == -1) {
				url += "&bbbsq_dm=01";
			} else {
				url = changeUrlArg(url, "bbbsq_dm", "01");
			}
			if (url.indexOf("sssqQ") == -1 && url.indexOf("sssqZ") == -1) {
				url += "&sssqQ=" + cwbbbsjcszData.nbsssqq + "&sssqZ=" + cwbbbsjcszData.nbsssqz;
			} else {
				url = changeUrlArg(url, "sssqQ", cwbbbsjcszData.nbsssqq);
				url = changeUrlArg(url, "sssqZ", cwbbbsjcszData.nbsssqz);
			}
			if (url.indexOf("kjzdzzDm") == -1) {
				url += "&kjzdzzDm=" + cwbbbsjcszData.kjzdzzDm + "&kjzdzzDm=" + cwbbbsjcszData.kjzdzzDm;
			} else {
				url = changeUrlArg(url, "kjzdzzDm", cwbbbsjcszData.kjzdzzDm);
			}

		} else {
			if (url.indexOf("sssqQ") == -1 && url.indexOf("sssqZ") == -1) {
				url += "&sssqQ=" + cwbbbsjcszData.sssqq + "&sssqZ=" + cwbbbsjcszData.sssqz;
			} else {
				url = changeUrlArg(url, "sssqQ", cwbbbsjcszData.sssqq);
				url = changeUrlArg(url, "sssqZ", cwbbbsjcszData.sssqz);
			}
			if (url.indexOf("kjzdzzDm") == -1) {
				url += "&kjzdzzDm=" + cwbbbsjcszData.kjzdzzDm + "&kjzdzzDm=" + cwbbbsjcszData.kjzdzzDm;
			} else {
				url = changeUrlArg(url, "kjzdzzDm", cwbbbsjcszData.kjzdzzDm);
			}

		}
		//取保存设置的资料小类代码
		if (url.indexOf("zlbsxlDm") == -1) {
			url += "&zlbsxlDm=" + cwbbbsjcszData.zlbsxlDm;
		} else {
			url = changeUrlArg(url, "zlbsxlDm", cwbbbsjcszData.zlbsxlDm);
		}
		if (isFinaljh) {
			url = url + "#";
		}
		parent.window.location.href = url;
	} else {
		var cwbbbsjcszData = formData.cwbbbsjcsz;
		var sbywbm = formData.cwbbbsjcsz.sbywbm.toUpperCase();
		if (sbywbm == null || sbywbm == undefined || sbywbm == "" || sbywbm == "undefined") {
			parent.window.location.href = url;
		}
		var cwbbbm = getCwbbbm(sbywbm);
		url = url.replace("cwbbjcsz", formData.cwbbbsjcsz.sbywbm.toLowerCase()).replace("setting", cwbbbm);
		url = url.replace("cwbbycsjcsz", formData.cwbbbsjcsz.sbywbm.toLowerCase()).replace("setting", cwbbbm);
		//弹窗的参数
		if (url.indexOf("&_bt=") == -1) {
			url = url + "&_bt=chreom";
		}
		if (url.indexOf("&_st=") == -1) {
			url = url + "&_st=sm,1,,,填写报表";
		}
		if (url.indexOf("sssqQ") == -1 && url.indexOf("sssqZ") == -1) {
			url = url + "&sssqQ=" + formData.cwbbbsjcsz.sssqq + "&sssqZ=" + formData.cwbbbsjcsz.sssqz;
		} else {
			url = changeUrlArg(url, 'sssqQ', formData.cwbbbsjcsz.sssqq);
			url = changeUrlArg(url, 'sssqZ', formData.cwbbbsjcsz.sssqz);
		}
		if (url.indexOf("kjzdzzDm") == -1) {
			url += "&kjzdzzDm=" + cwbbbsjcszData.kjzdzzDm + "&kjzdzzDm=" + cwbbbsjcszData.kjzdzzDm;
		} else {
			url = changeUrlArg(url, "kjzdzzDm", cwbbbsjcszData.kjzdzzDm);
		}
		var wjckrj = formData.cwbbbsjcsz.wjckrj;
		if (wjckrj == null || wjckrj == undefined || wjckrj == "" || wjckrj == "undefined") {
			wjckrj = "";
		}
		if (url.indexOf("wjckrj") == -1) {
			url = url + "&wjckrj=" + wjckrj;
		} else {
			url = changeUrlArg(url, 'wjckrj', wjckrj);
		}
		if (isFinaljh) {
			url = url + "#";
		}
		gotoURL(url);
	}
}

//打开URL方式
function gotoURL(url) {
	if (url.indexOf("bzz=csgj") > -1) {
		parent.location.href = url;
	} else if (url.indexOf("gos=true") > -1) {
		parent.window.open(url, "_self");
	} else {
		parent.window.open(url);
	}
}

function changeUrlArg(url, arg, val) {
	var pattern = arg + '=([^&]*)';
	var replaceText = arg + '=' + val;
	return url.match(pattern) ? url.replace(eval('/(' + arg + '=)([^&]*)/gi'), replaceText) : (url.match('[\?]') ? url + '&' + replaceText : url + '?' + replaceText);
}

function updateCwbbFormData(formData) {
	$('#formDataSpan').html(JSON.stringify(formData));
}

function isExternalSupported(funName) {
	if (window.external != undefined && funName in window.external) {
		return true;
	}
	return false;
}

//带出小类对应的附表
function getDzbd(zlbsxlDm) {
	var swjgDm = parent.formData.extraParam.djNsrxx.zgswjdm;
	if (swjgDm.indexOf('121') != 0 && swjgDm.indexOf('221') != 0) {
		return;
	}

	var url = parent.location.href;
	var djxh = parent.formData.extraParam.djNsrxx.djxh;
	
	var jsonData = {};

	var url = parent.location.href;
	if (url.charAt(url.length - 1) == '#') { //抹除#号
		url = url.substr(0, url.length - 1);
	}

	var gdslxDm = parent.$("#gdslxDm").val();

	var mainUrl = window.location.protocol + '//' + window.location.host + parent.cp;
	jsonData.zlbsxl = zlbsxlDm;
	jsonData.bsqj = parent.formData.cwbbbsjcsz.bsqj;
	jsonData.djxh = djxh;
	$.ajax({
		type: "POST",
		url: mainUrl + "/nssb/getDzbd.do",
		dataType: "json",
		contentType: "application/json",
		data: JSON.stringify(jsonData),
		success: function (data) {
			$("#cwbbfb").empty();
			var bsqjindex = data.indexOf("<bsqj>");
			if (bsqjindex != -1) {
				var bsqj = data.substring(bsqjindex);
				if ("<bsqj>01</bsqj>" == bsqj) {
					$("#xlxz").hide();
				}
				data = data.substring(0, bsqjindex);
			}
			if (data != "" && data != null && data != undefined) {
				var xmlDoc = $.parseXML(data);
				$("#cwbbfb").append("<thead class='test002' style='text-align:center;vertical-align:middle;'><td width='50%'><b>表单名称<b></td><td><b>选择</b></td><td><b>填报说明</b></td></thead>");

				$(xmlDoc).find('cwbbfb > cwbbfblb').each(function () {
					var bz = $(this).children("bz").text();
					if ("01" == bz) {
						$("#cwbbfb").append("<tr class='test001'><td>  " + $(this).children("mc").text() + "</td><td style='text-align:center;vertical-align:middle;'><input type='checkbox' checked name='dzbdckeckbox' disabled='disabled' value='" +
							$(this).children("bm").text() + "1'></td><td style='text-align:center;vertical-align:middle;'> 必报</td></tr>");
					}
				});
				$(xmlDoc).find('cwbbfb > cwbbfblb').each(function () {
					var bz = $(this).children("bz").text();
					if ("00" == bz) {
						$("#cwbbfb").append("<tr class='test001'><td>  " + $(this).children("mc").text() + "</td><td style='text-align:center;vertical-align:middle;'><label><input type='checkbox' name='dzbdckeckbox' value='" +
							$(this).children("bm").text() + "'></label></td><td style='text-align:center;vertical-align:middle;'>  据实填报</td></tr>");
					}
					if ("10" == bz) {
						$("#cwbbfb").append("<tr class='test001'><td>  " + $(this).children("mc").text() + "</td><td style='text-align:center;vertical-align:middle;'><label><input type='checkbox' checked name='dzbdckeckbox' value='" +
							$(this).children("bm").text() + "'></label></td><td style='text-align:center;vertical-align:middle;'>  据实填报</td></tr>");
					}
				});
			}
		}
	});
	$('#iframehtm', window.parent.document).attr("height", $(document).height());
}

//获取引导页选择的附表
function getSelectDzbd() {
	var checkedFiles = $("input:checkbox[name='dzbdckeckbox']:checked");
	var dzbd = "";
	if (checkedFiles == undefined || checkedFiles.length == 0) {
		return
	}
	$.each(checkedFiles, function (key, box) { //循环遍历获取到的checkboxs
		if (box.value != "") { //当前checkbox的value不为空时执行以下操作
			dzbd = dzbd + box.value + "-";
		}
	})
	if (dzbd.length > 1) {
		dzbd = dzbd.substring(0, dzbd.length - 1);
	}
	return dzbd;
}

function getzsxlDm(scope) {
	var url = parent.location.href;
	if (url.charAt(url.length - 1) == '#') { //抹除#号
		url = url.substr(0, url.length - 1);
	}
	//url = url+"&xx";
	/**
	增加额外参数。下方多处采用substring取参数值(分支版本)。为避免最后一个参数无法正确取出。
	要抹除url末尾的#并多加一个&  主干版本已做处理。此处url = url+"&xx";可屏蔽，也可以继续保留。
	 */
	var mainUrl = window.location.protocol + '//' + window.location.host + parent.cp;
	var jsonData = {};
	var tjNdIndex = url.indexOf("tjNd=");
	var tjYfIndex = url.indexOf("tjYf=");
	var bzzIndex = url.indexOf("bzz=");
	var zlbsxlDmIndex = url.indexOf("zlbsxlDm=");
	var skssqQIndex = url.indexOf("skssqQ=");
	var skssqZIndex = url.indexOf("skssqZ=");
	var nsqxDm = "YJ";
	var tjNd = "2017";
	var tjYf = "04";
	var djxh = parent.formData.extraParam.djNsrxx.djxh;
	var gdslxDm = parent.$("#gdslxDm").val();
	var zlbsxlDm = "";
	var zlbsxlYJCT = {};
	var zlbsxlNDCT = {};
	var bzz = "";
	var isCwbabz = "Y";
	var isCwbabzIndex = url.indexOf("isCwbabz=");
	var kjzdzzDm = "";
	var kjzdzzDmIndex = url.indexOf("kjzdzzDm=");
	var gsdq = "";
	var gsdqIndex = url.indexOf("gsdq=");
	if (bzzIndex != -1) {
		if (url.indexOf("&", bzzIndex) != -1) {
			bzz = url.substring(bzzIndex + "bzz=".length, url.indexOf("&", bzzIndex));
			if (bzz == "csgj") {
				return;
			}
		} else {
			bzz = url.substring(bzzIndex + "bzz=".length);
			if (bzz == "csgj") {
				return;
			}
		}
	}
	if (skssqQIndex != -1 && skssqZIndex != -1) {
		var skssqQ = null;
		var skssqZ = null;
		if (url.indexOf("&", skssqQIndex) != -1) {
			skssqQ = url.substring(skssqQIndex + "skssqQ=".length, url.indexOf("&", skssqQIndex));
		} else {
			skssqQ = url.substring(skssqQIndex + "skssqQ=".length);
		}
		if (url.indexOf("&", skssqZIndex) != -1) {
			skssqZ = url.substring(skssqZIndex + "skssqZ=".length, url.indexOf("&", skssqZIndex));
		} else {
			skssqZ = url.substring(skssqZIndex + "skssqZ=".length);
		}
		nsqxDm = calculateNsqxDm(skssqQ, skssqZ);
	}
	if (zlbsxlDmIndex != -1) {
		if (url.indexOf("&", zlbsxlDmIndex) != -1) {
			zlbsxlDm = url.substring(zlbsxlDmIndex + "zlbsxlDm=".length, url.indexOf("&", zlbsxlDmIndex));
		} else {
			zlbsxlDm = url.substring(zlbsxlDmIndex + "zlbsxlDm=".length);
		}
	}
	if (tjNdIndex != -1) {
		if (url.indexOf("&", tjNdIndex) != -1) {
			tjNd = url.substring(tjNdIndex + "tjNd=".length, url.indexOf("&", tjNdIndex));
		} else {
			tjNd = url.substring(tjNdIndex + "tjNd=".length);
		}
	}
	if (tjYfIndex != -1) {
		if (url.indexOf("&", tjYfIndex) != -1) {
			tjYf = url.substring(tjYfIndex + "tjYf=".length, url.indexOf("&", tjYfIndex));
		} else {
			tjYf = url.substring(tjYfIndex + "tjYf=".length);
		}
	}
	if (isCwbabzIndex != -1) {
		if (url.indexOf("&", isCwbabzIndex) != -1) {
			isCwbabz = url.substring(isCwbabzIndex + "isCwbabz=".length, url.indexOf("&", isCwbabzIndex));
		} else {
			isCwbabz = url.substring(isCwbabzIndex + "isCwbabz=".length);
		}
	}
	if (kjzdzzDmIndex != -1) {
		if (url.indexOf("&", kjzdzzDmIndex) != -1) {
			kjzdzzDm = url.substring(kjzdzzDmIndex + "kjzdzzDm=".length, url.indexOf("&", kjzdzzDmIndex));
		} else {
			kjzdzzDm = url.substring(kjzdzzDmIndex + "kjzdzzDm=".length);
		}
	}
	if (gsdqIndex != -1) {
		if (url.indexOf("&", gsdqIndex) != -1) {
			gsdq = url.substring(gsdqIndex + "gsdq=".length, url.indexOf("&", gsdqIndex));
		} else {
			gsdq = url.substring(gsdqIndex + "gsdq=".length);
		}
	}
	jsonData.sid = "ETax.SB.QryCwbbZlbs.YsbxxService";
	jsonData.tjNd = tjNd;
	jsonData.djxh = djxh;
	jsonData.zgswskfjDm = '00000000000';
	jsonData.tjYf = tjYf;
	jsonData.bsssqq = parent.formData.cwbbbsjcsz.sssqq;
	//	jsonData.bsssqq = '';
	jsonData.bsssqz = parent.formData.cwbbbsjcsz.sssqz;
	//	jsonData.bsssqz = '';
	jsonData.gdslxDm = gdslxDm;

	$.ajax({
		type: "POST",
		url: mainUrl + "/nssb/getOtherData.do",
		dataType: "json",
		contentType: "application/json",
		data: JSON.stringify(jsonData),
		success: function (data) {
			if (data != "" && data != null && data != undefined) {
				var i = 0;
				var j = 0;
				if (zlbsxlDm != "" && zlbsxlDm != null && zlbsxlDm != undefined) {
					//如果清册有带小类，就爆清册带的小类
					zlbsxlYJCT[zlbsxlDm] = zlbsxl[zlbsxlDm];
					zlbsxlNDCT[zlbsxlDm] = zlbsxl[zlbsxlDm];
				} else {
					//如果没带小类，查对照表，且不需校验千户集团，千户集团有单独入口
					var xmlDoc = $.parseXML(data);
					$(xmlDoc).find('zlxlGrid > zlxlGridlb').each(function () {
						if (zlbsxlNDCT[$(this).children("zlbsxlDm").text()] == undefined || zlbsxlNDCT[$(this).children("zlbsxlDm").text()] == null || zlbsxlNDCT[$(this).children("zlbsxlDm").text()] == '') {
							//月季报
							if ($(this).children("zlbsxlDm").text() != 'ZL1001045') {
								zlbsxlYJCT[$(this).children("zlbsxlDm").text()] = zlbsxl[$(this).children("zlbsxlDm").text()];
								i++;
							}
							//年报
							if ($(this).children("zlbsxlDm").text() != 'ZL1001045') {
								zlbsxlNDCT[$(this).children("zlbsxlDm").text()] = zlbsxl[$(this).children("zlbsxlDm").text()];
								j++;
							}
						}
					});
				}
				var cwbaTemp = "Y";
				var swjgDm = parent.formData.extraParam.djNsrxx.zgswjdm;
				if (swjgDm.indexOf('152') == 0 || swjgDm.indexOf('252') == 0 || swjgDm.indexOf('163') == 0 || swjgDm.indexOf('263') == 0) {
					//贵州,青海当备案大类为其它时,可以选择所有小类
					if (isCwbabz == "Y" && "dzswj" == bzz && (kjzdzzDm != zlbsxlKjzdDz[zlbsxlDm]) || (swjgDm.indexOf('152') == 0 || swjgDm.indexOf('252') == 0)) {
						isCwbabz = "N";
						cwbaTemp = "N";
					}
				}
				//SXGS12366-9陕西需求
				if (swjgDm.indexOf('161') == 0) {
					if (isCwbabz == "Y" && "dzswj" == bzz) {
						cwbaTemp = "N";
					}
					isCwbabz = "N";
				}

				if (isCwbabz == "N") {
					scope.formData.isCwbabz = isCwbabz;
					//无备案时小类下拉值初始化规则
					//checkIsQhjt(scope,jsonData);//校验是否是千户企业;20170627,千户企业单独入口，不需再做千户企业的校验
					var rtnData = {};
					if (swjgDm.indexOf('152') == 0 || swjgDm.indexOf('252') == 0) {
						//贵州,青海无备案情况新规则
						rtnData = initZlbsxlDm1(kjzdzzDm, gsdq, scope);
					} else if (swjgDm.indexOf('161') == 0) {
						//陕西无备案情况新规则
						rtnData = initZlbsxlDm4(kjzdzzDm, gsdq, scope);
					} else if (swjgDm.indexOf('163') == 0 || swjgDm.indexOf('263') == 0) {
						rtnData = initZlbsxlDm2(kjzdzzDm, gsdq, scope);
					} else if (swjgDm.indexOf('121') == 0 || swjgDm.indexOf('221') == 0) {
						//大连特殊需求
						rtnData = initZlbsxlDm3(kjzdzzDm, parent.formData.cwbbbsjcsz.hydm, scope);
					} else {
						rtnData = initZlbsxlDm(kjzdzzDm, gsdq, scope);
					}

					if (nsqxDm == 'YJ') {
						zlbsxlYJCT = rtnData;
					} else {
						zlbsxlNDCT = rtnData;
					}
					//青海有备案时锁住报送期间
					if (swjgDm.indexOf('163') == 0 || swjgDm.indexOf('263') == 0) {
						if (nsqxDm == 'YJ') {
							$('#bsqjId')[0].setAttribute("disabled", "disabled");
						}

					} else if (swjgDm.indexOf('161') == 0 && cwbaTemp == "N") {
						if (nsqxDm == 'YJ') {
							$('#bsqjId')[0].setAttribute("disabled", "disabled");
						}
						$('#sssqqId').attr('disabled', true);
						$('#sssqzId').attr('disabled', true);
					} else {
						$('#bsqjId')[0].removeAttribute("disabled");
					}

				} else {
					//GZDSDZSWJ-187:优化下全国版财务报表引导页，当只有一个纳税期限时，属期默认带出不可修改。
					if (swjgDm.indexOf('152') == 0 || swjgDm.indexOf('252') == 0) {
						$('#bsqjId')[0].removeAttribute("disabled");
					} else if (swjgDm.indexOf('163') == 0 || swjgDm.indexOf('263') == 0) {
						if (nsqxDm == 'YJ') {
							$('#bsqjId')[0].setAttribute("disabled", "disabled");
						}
					} else {
						$('#sssqqId').attr('disabled', true);
						$('#sssqzId').attr('disabled', true);
						if (nsqxDm == 'YJ') {
							$('#bsqjId')[0].setAttribute("disabled", "disabled");
						} else if (nsqxDm == 'ND' && (swjgDm.indexOf('137') == 0 || swjgDm.indexOf('237') == 0)) {
							//年报青岛锁住所属年份 SW2107150-39
							$('#nbTr1 .select01').attr('disabled', true);
						}
					}
				}

				if (nsqxDm == 'YJ') {
					scope["CT"]["zlbsxlCT"] = zlbsxlYJCT;
					scope.formData.cwbbbsjcsz.bblx = '0';
					if (Object.getOwnPropertyNames && Object.getOwnPropertyNames(zlbsxlYJCT).length == 1) {
						zlbsxlDm = Object.getOwnPropertyNames(zlbsxlYJCT)[0];
					} else if (JSON.stringify(zlbsxlYJCT).indexOf(",") == -1) {
						for (k in zlbsxlYJCT) {
							zlbsxlDm = k;
						}
					}
				} else {
					scope["CT"]["zlbsxlCT"] = zlbsxlNDCT;
					scope.formData.cwbbbsjcsz.bblx = '1';
					if (Object.getOwnPropertyNames && Object.getOwnPropertyNames(zlbsxlNDCT).length == 1) {
						zlbsxlDm = Object.getOwnPropertyNames(zlbsxlNDCT)[0];
					} else if (JSON.stringify(zlbsxlNDCT).indexOf(",") == -1) {
						for (k in zlbsxlNDCT) {
							zlbsxlDm = k;
						}
					}
				}

				//记录月季和年报的可选项
				$('#zlbsxlYJNum').val(isCwbabz == "N" ? 2 : i);
				$('#zlbsxlNDNum').val(isCwbabz == "N" ? 2 : j);
				$('#zlbsxlYJCT').val(JSON.stringify(zlbsxlYJCT));
				$('#zlbsxlNDCT').val(JSON.stringify(zlbsxlNDCT));
			}
			//默认隐藏,初始化显示报送期间
			$('#bblx1').css('display', 'none');
			$('#bblx2').css('display', 'none');
			$('#bblx').css('display', 'none');
			scope.changeZlbsxl(zlbsxlDm); //默认为月季
		}
	});
}

function calculateNsqxDm(sssqQ, sssqZ) {
	var yfQ = sssqQ.substring(5, 7);
	var yfZ = sssqZ.substring(5, 7);
	var result = parseInt(yfZ, 10) - parseInt(yfQ, 10);
	if (result == 11) {
		return "ND";
	} else {
		return "YJ";
	}
}

/*
小企业：		没有会计制度；或会计制度为102；或会计制度为201且税务机关以152开头；
一般企业：		没有会计制度；或会计制度为101；或会计制度为201且税务机关以152开头；
保险类金融：	没有会计制度；或会计制度为201；
担保类金融：	没有会计制度；或会计制度为201；
证券类金融：	没有会计制度；或会计制度为201；
银行类金融：	没有会计制度；或会计制度为201；
事业单位：		会计制度为216；或会计制度为201且税务机关以152开头；或没有会计制度；
民间非营利组织：会计制度为222；或会计制度为201且税务机关以152开头；或没有会计制度；
农民专业合作：	会计制度为223；或会计制度为201且税务机关以152开头；或没有会计制度；
企业会计制度：	会计制度为201；或没有会计制度；
金融控股：		会计制度为201；或没有会计制度；
金融资产：		会计制度为201；或没有会计制度；
保险公司：		会计制度为101；或没有会计制度；或会计制度为201且税务机关以152开头；
商业银行：		会计制度为101；或没有会计制度；或会计制度为201且税务机关以152开头；
证券公司：		会计制度为101；或没有会计制度；或会计制度为201且税务机关以152开头；
村集体：		会计制度为224；或会计制度为201且税务机关以152开头；或没有会计制度；
个体工商户：	会计制度为215；或会计制度为201且税务机关以152开头；或没有会计制度；

企业集团合并：首先必须是千户企业，其次：会计制度为101；或没有会计制度；或会计制度为201且税务机关以152开头；

如果全部都不符合，下拉列出所有选项供选择。
 */
function initZlbsxlDm(kjzdzzDm, gsdq, scope) {

	var rtnData = {};
	var isAllbz = "Y";

	// 小企业：	没有会计制度；或会计制度为201且税务机关以152开头；或会计制度为102；
	//一般企业：	没有会计制度；或会计制度为201且税务机关以152开头；或会计制度为101；
	if (kjzdzzDm == "" || (kjzdzzDm == "201" && gsdq == "152") || kjzdzzDm == "102") {
		rtnData.ZL1001003 = zlbsxl.ZL1001003;
		isAllbz = "N";
	}
	if (kjzdzzDm == "" || (kjzdzzDm == "201" && gsdq == "152") || kjzdzzDm == "101") {
		rtnData.ZL1001001 = zlbsxl.ZL1001001;
		isAllbz = "N";
	}
	//保险类金融：没有会计制度；或会计制度为201；
	//担保类金融：没有会计制度；或会计制度为201；
	//证券类金融：没有会计制度；或会计制度为201；
	//银行类金融：没有会计制度；或会计制度为201；
	if (kjzdzzDm == "" || kjzdzzDm == "201") {
		rtnData.ZL1001036 = zlbsxl.ZL1001036;
		rtnData.ZL1001037 = zlbsxl.ZL1001037;
		rtnData.ZL1001038 = zlbsxl.ZL1001038;
		rtnData.ZL1001039 = zlbsxl.ZL1001039;
		isAllbz = "N";
	}
	//事业单位：		或会计制度为201且税务机关以152开头；或没有会计制度；会计制度为216；
	//民间非营利组织：	或会计制度为201且税务机关以152开头；或没有会计制度；会计制度为222；
	//农民专业合作：	或会计制度为201且税务机关以152开头；或没有会计制度；会计制度为223；
	if ((kjzdzzDm == "201" && gsdq == "152") || kjzdzzDm == "" || kjzdzzDm == "216") {
		rtnData.ZL1001024 = zlbsxl.ZL1001024;
		isAllbz = "N";
	}
	if ((kjzdzzDm == "201" && gsdq == "152") || kjzdzzDm == "" || kjzdzzDm == "222") {
		rtnData.ZL1001023 = zlbsxl.ZL1001023;
		isAllbz = "N";
	}
	if ((kjzdzzDm == "201" && gsdq == "152") || kjzdzzDm == "" || kjzdzzDm == "223") {
		rtnData.ZL1001015 = zlbsxl.ZL1001015;
		isAllbz = "N";
	}
	//企业会计制度：	会计制度为201；或没有会计制度；
	//金融控股：		会计制度为201；或没有会计制度；
	//金融资产：		会计制度为201；或没有会计制度；
	if ((kjzdzzDm == "201") || kjzdzzDm == "") {
		rtnData.ZL1001002 = zlbsxl.ZL1001002;
		rtnData.ZL1001040 = zlbsxl.ZL1001040;
		rtnData.ZL1001041 = zlbsxl.ZL1001041;
		isAllbz = "N";
	}
	//保险公司：会计制度为101；或没有会计制度；或会计制度为201且税务机关以152开头；
	//商业银行：会计制度为101；或没有会计制度；或会计制度为201且税务机关以152开头；
	//证券公司：会计制度为101；或没有会计制度；或会计制度为201且税务机关以152开头；
	if ((kjzdzzDm == "101") || kjzdzzDm == "" || (kjzdzzDm == "201" && gsdq == "152")) {
		rtnData.ZL1001018 = zlbsxl.ZL1001018;
		rtnData.ZL1001019 = zlbsxl.ZL1001019;
		rtnData.ZL1001020 = zlbsxl.ZL1001020;
		isAllbz = "N";
	}
	//村集体：	或会计制度为201且税务机关以152开头；或没有会计制度；会计制度为224；
	//个体工商户：	或会计制度为201且税务机关以152开头；或没有会计制度；会计制度为215；
	if ((kjzdzzDm == "201" && gsdq == "152") || kjzdzzDm == "" || kjzdzzDm == "224") {
		rtnData.ZL1001043 = zlbsxl.ZL1001043;
		isAllbz = "N";
	}
	if ((kjzdzzDm == "201" && gsdq == "152") || kjzdzzDm == "" || kjzdzzDm == "215") {
		rtnData.ZL1001044 = zlbsxl.ZL1001044;
		isAllbz = "N";
	}
	//如果全部都不符合，下拉列出所有选项供选择。
	if (isAllbz == "Y") {
		rtnData = {
			"ZL1001001": "企业会计准则（一般企业）财务报表报送与信息采集",
			"ZL1001002": "企业会计制度财务报表报送与信息采集",
			"ZL1001003": "小企业会计准则财务报表与信息采集",
			"ZL1001015": "农民专业合作社财务会计制度财务报表报送与信息采集",
			"ZL1001018": "企业会计准则（商业银行）财务报表报送与信息采集",
			"ZL1001019": "企业会计准则（证券公司）财务报表报送与信息采集",
			"ZL1001020": "企业会计准则（保险公司）财务报表报送与信息采集",
			"ZL1001023": "民间非营利组织会计制度财务报表报送与信息采集",
			"ZL1001024": "事业单位会计制度财务报表报送与信息采集",
			"ZL1001036": "银行类金融企业财务报表报送与信息采集",
			"ZL1001037": "证券类金融企业财务报表报送与信息采集",
			"ZL1001038": "保险类金融企业财务报表报送与信息采集",
			"ZL1001039": "担保类金融企业财务报表报送与信息采集",
			"ZL1001040": "金融控股集团公司类金融企业财务报表报送与信息采集",
			"ZL1001041": "金融资产管理公司类金融企业财务报表报送与信息采集",
			"ZL1001043": "村集体经济组织财务报表报送与信息采集",
			"ZL1001044": "个体工商户财务报表报送与信息采集",
			"ZL1001030": "文化事业单位会计制度财务报表报送与信息采集",
			"ZL1001031": "广播事业单位会计制度财务报表报送与信息采集",
			"ZL1001032": "体育事业单位会计制度财务报表报送与信息采集",
			"ZL1001034": "人口和计划生育事业单位会计制度财务报表报送与信息采集",
			"ZL1001029": "测绘事业单位会计制度财务报表报送与信息采集",
			"ZL1001028": "科学事业单位会计制度财务报表报送与信息采集",
			"ZL1001027": "医院会计制度财务报表报送与信息采集",
			"ZL1001026": "高等学校会计制度财务报表报送与信息采集",
			"ZL1001025": "中小学校会计制度财务报表报送与信息采集",
			"ZL1001016": "勘察设计企业会计制度财务报表报送与信息采集",
			"ZL1001010": "行业会计制度（运输[交通]）财务报表报送与信息采集",
			"ZL1001017": "企业会计制度（保险中介公司会计核算办法）财务报表报送与信息采集",
			"ZL1001042": "彩票机构会计制度财务报表报送与信息采集",
			"ZL1001047": "基层医疗卫生机构会计制度财务报表资料报送与信息采集",
			"ZL1001012": "企业会计制度（民航企业会计核算办法）财务报表报送与信息采集",
			"ZL1001033": "文物事业单位会计制度财务报表报送与信息采集",
			"ZL1001046": "行政单位会计制度财务报表报送与信息采集",
			"ZL1001021": "企业会计准则（典当企业）财务报表报送与信息采集"
		};
	}
	scope.formData.isAllbz = isAllbz;
	scope.formData.gsdq = gsdq;
	return rtnData;
}

//GZDSDZSWJ-1063新需求,无备案时下拉列出所有选项供选择
function initZlbsxlDm1(kjzdzzDm, gsdq, scope) {
	scope.formData.cwbbbsjcsz.cwkjzdzz = "900";
	scope.formData.cwbbbsjcsz.kjzdzzDm = "";
	scope.formData.cwbbbsjcsz.zlbsxl = "";
	scope.formData.cwbbbsjcsz.zlbsxlDm = "";
	var rtnData = {};
	rtnData = {
		"ZL1001001": "企业会计准则（一般企业）财务报表报送与信息采集",
		"ZL1001002": "企业会计制度财务报表报送与信息采集",
		"ZL1001003": "小企业会计准则财务报表与信息采集",
		"ZL1001015": "农民专业合作社财务会计制度财务报表报送与信息采集",
		"ZL1001018": "企业会计准则（商业银行）财务报表报送与信息采集",
		"ZL1001019": "企业会计准则（证券公司）财务报表报送与信息采集",
		"ZL1001020": "企业会计准则（保险公司）财务报表报送与信息采集",
		"ZL1001023": "民间非营利组织会计制度财务报表报送与信息采集",
		"ZL1001024": "事业单位会计制度财务报表报送与信息采集",
		"ZL1001036": "银行类金融企业财务报表报送与信息采集",
		"ZL1001037": "证券类金融企业财务报表报送与信息采集",
		"ZL1001038": "保险类金融企业财务报表报送与信息采集",
		"ZL1001039": "担保类金融企业财务报表报送与信息采集",
		"ZL1001040": "金融控股集团公司类金融企业财务报表报送与信息采集",
		"ZL1001041": "金融资产管理公司类金融企业财务报表报送与信息采集",
		"ZL1001043": "村集体经济组织财务报表报送与信息采集",
		"ZL1001044": "个体工商户财务报表报送与信息采集",
		"ZL1001030": "文化事业单位会计制度财务报表报送与信息采集",
		"ZL1001031": "广播事业单位会计制度财务报表报送与信息采集",
		"ZL1001032": "体育事业单位会计制度财务报表报送与信息采集",
		"ZL1001034": "人口和计划生育事业单位会计制度财务报表报送与信息采集",
		"ZL1001029": "测绘事业单位会计制度财务报表报送与信息采集",
		"ZL1001028": "科学事业单位会计制度财务报表报送与信息采集",
		"ZL1001027": "医院会计制度财务报表报送与信息采集",
		"ZL1001026": "高等学校会计制度财务报表报送与信息采集",
		"ZL1001025": "中小学校会计制度财务报表报送与信息采集",
		"ZL1001016": "勘察设计企业会计制度财务报表报送与信息采集",
		"ZL1001010": "行业会计制度（运输[交通]）财务报表报送与信息采集",
		"ZL1001017": "企业会计制度（保险中介公司会计核算办法）财务报表报送与信息采集",
		"ZL1001042": "彩票机构会计制度财务报表报送与信息采集",
		"ZL1001047": "基层医疗卫生机构会计制度财务报表资料报送与信息采集",
		"ZL1001012": "企业会计制度（民航企业会计核算办法）财务报表报送与信息采集",
		"ZL1001033": "文物事业单位会计制度财务报表报送与信息采集",
		"ZL1001046": "行政单位会计制度财务报表报送与信息采集",
		"ZL1001045": "企业集团合并财务报表报送与信息采集",
		"ZL1001022": "企业会计准则（担保企业会计核算办法）财务报表报送与信息采集",
		"ZL1001021": "企业会计准则（典当企业）财务报表报送与信息采集"
	};
	return rtnData;
}
//QHGSDZSWJ-330新需求,青海新需求
function initZlbsxlDm2(kjzdzzDm, gsdq, scope) {
	scope.formData.cwbbbsjcsz.cwkjzdzz = "900";
	scope.formData.cwbbbsjcsz.kjzdzzDm = "";
	scope.formData.cwbbbsjcsz.zlbsxl = "";
	scope.formData.cwbbbsjcsz.zlbsxlDm = "";
	var rtnData = {};
	rtnData = {
		"ZL1001001": "企业会计准则（一般企业）财务报表报送与信息采集",
		"ZL1001002": "企业会计制度财务报表报送与信息采集",
		"ZL1001003": "小企业会计准则财务报表与信息采集",
		"ZL1001015": "农民专业合作社财务会计制度财务报表报送与信息采集",
		"ZL1001018": "企业会计准则（商业银行）财务报表报送与信息采集",
		"ZL1001019": "企业会计准则（证券公司）财务报表报送与信息采集",
		"ZL1001020": "企业会计准则（保险公司）财务报表报送与信息采集",
		"ZL1001023": "民间非营利组织会计制度财务报表报送与信息采集",
		"ZL1001024": "事业单位会计制度财务报表报送与信息采集",
		"ZL1001036": "银行类金融企业财务报表报送与信息采集",
		"ZL1001037": "证券类金融企业财务报表报送与信息采集",
		"ZL1001038": "保险类金融企业财务报表报送与信息采集",
		"ZL1001039": "担保类金融企业财务报表报送与信息采集",
		"ZL1001040": "金融控股集团公司类金融企业财务报表报送与信息采集",
		"ZL1001041": "金融资产管理公司类金融企业财务报表报送与信息采集",
		"ZL1001043": "村集体经济组织财务报表报送与信息采集",
		"ZL1001044": "个体工商户财务报表报送与信息采集",
	};
	return rtnData;
}
function initZlbsxlDm4(kjzdzzDm, gsdq, scope) {
	var rtnData = {};
	var kjzdZlbsxlDz = {
		"101": {
			"mc": "企业会计准则",
			"zlbsxl": {
				"ZL1001001": "企业会计准则（一般企业）财务报表报送与信息采集",
				"ZL1001018": "企业会计准则（商业银行）财务报表报送与信息采集",
				"ZL1001019": "企业会计准则（证券公司）财务报表报送与信息采集",
				"ZL1001020": "企业会计准则（保险公司）财务报表报送与信息采集",
				"ZL1001021": "企业会计准则（典当企业）财务报表报送与信息采集",
				"ZL1001045": "企业集团合并财务报表报送与信息采集"
			}
		},
		"201": {
			"mc": "企业会计制度（2001）",
			"zlbsxl": {
				"ZL1001002": "企业会计制度财务报表报送与信息采集",
				"ZL1001036": "银行类金融企业财务报表报送与信息采集",
				"ZL1001037": "证券类金融企业财务报表报送与信息采集",
				"ZL1001038": "保险类金融企业财务报表报送与信息采集",
				"ZL1001039": "担保类金融企业财务报表报送与信息采集",
				"ZL1001040": "金融控股集团公司类金融企业财务报表报送与信息采集"
			}
		},
		"102": {
			"mc": "小企业会计准则",
			"zlbsxl": {
				"ZL1001003": "小企业会计准则财务报表与信息采集"
			}
		},
		"222": {
			"mc": "民间非营利组织会计制度",
			"zlbsxl": {
				"ZL1001023": "民间非营利组织会计制度财务报表报送与信息采集"
			}
		},
		"216": {
			"mc": "事业单位会计制度",
			"zlbsxl": {
				"ZL1001024": "事业单位会计制度财务报表报送与信息采集",
				"ZL1001030": "文化事业单位会计制度财务报表报送与信息采集",
				"ZL1001031": "广播事业单位会计制度财务报表报送与信息采集",
				"ZL1001033": "文物事业单位会计制度财务报表报送与信息采集",
				"ZL1001034": "人口和计划生育事业单位会计制度财务报表报送与信息采集",
				"ZL1001032": "体育事业单位会计制度财务报表报送与信息采集"
			}
		},
		"224": {
			"mc": "村集体经济组织会计制度",
			"zlbsxl": {
				"ZL1001043": "村集体经济组织财务报表报送与信息采集"
			}
		},
		"215": {
			"mc": "个体工商户会计制度",
			"zlbsxl": {
				"ZL1001044": "个体工商户财务报表报送与信息采集"
			}
		},
		"223": {
			"mc": "农民专业合作社财务会计制度（试行）",
			"zlbsxl": {
				"ZL1001015": "农民专业合作社财务会计制度财务报表报送与信息采集"
			}
		},
		"231": {
			"mc": "金融资产管理公司会计制度",
			"zlbsxl": {
				"ZL1001041": "金融资产管理公司类金融企业财务报表报送与信息采集"
			}
		},
		"211": {
			"mc": "运输（交通）企业会计制度",
			"zlbsxl": {
				"ZL1001010": "行业会计制度（运输[交通]）财务报表报送与信息采集"
			}
		},
		"206": {
			"mc": "勘察设计企业会计制度",
			"zlbsxl": {
				"ZL1001016": "勘察设计企业会计制度财务报表报送与信息采集"
			}
		},
		"220": {
			"mc": "中小学校会计制度（试行）",
			"zlbsxl": {
				"ZL1001025": "中小学校会计制度财务报表报送与信息采集"
			}
		},
		"219": {
			"mc": "高等学校会计制度",
			"zlbsxl": {
				"ZL1001026": "高等学校会计制度财务报表报送与信息采集"
			}
		},
		"221": {
			"mc": "医院会计制度",
			"zlbsxl": {
				"ZL1001027": "医院会计制度财务报表报送与信息采集"
			}
		},
		"229": {
			"mc": "科学事业单位会计制度",
			"zlbsxl": {
				"ZL1001028": "科学事业单位会计制度财务报表报送与信息采集"
			}
		},
		"218": {
			"mc": "测绘事业单位会计制度",
			"zlbsxl": {
				"ZL1001029": "测绘事业单位会计制度财务报表报送与信息采集"
			}
		},
		"204": {
			"mc": "保险中介公司会计核算办法",
			"zlbsxl": {
				"ZL1001017": "企业会计制度（保险中介公司会计核算办法）财务报表报送与信息采集"
			}
		},
		"230": {
			"mc": "彩票机构会计制度",
			"zlbsxl": {
				"ZL1001042": "彩票机构会计制度财务报表报送与信息采集"
			}
		},
		"232": {
			"mc": "基层医疗卫生机构会计制度",
			"zlbsxl": {
				"ZL1001047": "基层医疗卫生机构会计制度财务报表资料报送与信息采集"
			}
		},
		"268": {
			"mc": "民航企业会计核算办法",
			"zlbsxl": {
				"ZL1001012": "企业会计制度（民航企业会计核算办法）财务报表报送与信息采集"
			}
		},
		"227": {
			"mc": "行政单位会计制度",
			"zlbsxl": {
				"ZL1001046": "行政单位会计制度财务报表报送与信息采集"
			}
		}
	};
	rtnData = kjzdZlbsxlDz[kjzdzzDm].zlbsxl;

	var iCount = 0;
	var hyDm = "";
	var tmpextraParam = parent.formData.extraParam;
	if (tmpextraParam != null && tmpextraParam != undefined) {
		var djNsrxx = parent.formData.extraParam.djNsrxx;
		if (djNsrxx != null && djNsrxx != undefined) {
			hyDm = djNsrxx.hydm;
		}
	}
	if (hyDm == "" || hyDm == null || hyDm == undefined) {
		hyDm = "";
	}

	var jsonDataUrl = window.location.protocol + '//' + window.location.host + '/sbzs-cjpt-web/biz/setting/cwbbydy/setting/zlbsxl_kjzdzz_hy.json';
	var jsonData = null;
	$.ajax({
		url: jsonDataUrl,
		dataType: 'text',
		headers: {
			"Accept": "text/plain;charset=UTF-8"
		},
		async: false,
		success: function (datas) {
			jsonData = datas;
		}
	});
	var items;
	var rtnDataNew = {};
	if (!jsonData instanceof Object || typeof jsonData == "string") {
		items = JSON.parse(jsonData);
	} else {
		items = datas;
	}
	for (var i = 0; i < items.zlbsxlkjzdzzhy.length; i++) {
		var tmpItem = items.zlbsxlkjzdzzhy[i];
		var tmpkjzdzzDm = tmpItem.kjzdzzDm;
		if (kjzdzzDm == tmpkjzdzzDm) {
			var tmpHydm = tmpItem.hyDm;
			if (tmpHydm == "%") { // %的情况表示所有行业都适用
				iCount++;
				rtnDataNew[tmpItem.zlbsxlDm] = tmpItem.zlbsxlmc;
			} else {
				tmpHydm = tmpHydm.replace("%", ""); // 去掉里面的%
				// if (hyDm.startsWith(tmpHydm)) {
				if (hyDm.substring(0,tmpHydm.length) == tmpHydm) {
					iCount++;
					rtnDataNew[tmpItem.zlbsxlDm] = tmpItem.zlbsxlmc;
				}
			}
		}
	}
	if (iCount > 0) {
		return rtnDataNew;
	}
	return rtnData;
}

//DLGS-170大连下拉规则
function initZlbsxlDm3(kjzdzzDm, hydm, scope) {
	var rtnData = {};
	_startfrom = "dlgswba"
		rtnData.ZL1001001 = zlbsxl.ZL1001001;
	rtnData.ZL1001003 = zlbsxl.ZL1001003;
	scope.formData.cwbbbsjcsz.bsqj = "03";
	scope.bsqjToSsq();

	return rtnData;

}
/**
 * 校验账号是否是千户企业
 * @param scope
 * @param jsonData
 */
function checkIsQhjt(scope, jsonData) {
	//默认不是千户集团企业
	var isQhjt = "N";
	var mainUrl = window.location.protocol + '//' + window.location.host + parent.cp;

	var pramData = {};
	pramData.sid = "ETax.SB.InitValidate.91061008001";
	pramData.djxh = parent.formData.extraParam.djNsrxx.djxh;
	pramData.gdslxDm = jsonData.gdslxDm;
	pramData.nsrsbh = parent.formData.extraParam.djNsrxx.nsrsbh;
	pramData.zgswjDm = "00000000000";

	$.ajax({
		type: "POST",
		url: mainUrl + "/nssb/getOtherData.do",
		dataType: "json",
		contentType: "application/json",
		data: JSON.stringify(pramData),
		async: false,
		success: function (data) {
			if (data != "" && data != null && data != undefined) {
				var xmlDoc = $.parseXML(data);
				isQhjt = $(xmlDoc).find('isQhjt').text();
				scope.formData.isQhjt = isQhjt;
			}
		}
	});
}

parent.updateCwbbData = function (formData) {
	var $scope = angular.element($("#viewCtrlId")).scope();
	$scope.formData.cwbbbsjcsz.cwkjzdzz = formData.cwbbbsjcsz.cwkjzdzz;
	$scope.formData.cwbbbsjcsz.zlbsxl = formData.cwbbbsjcsz.zlbsxl;
	if ($scope.formData.cwbbbsjcsz.cwkjzdzz != null && $scope.formData.cwbbbsjcsz.cwkjzdzz != "") {
		$scope.zlbsxlControl();
	}
	$scope.formData.cwbbbsjcsz.bsqj = formData.cwbbbsjcsz.bsqj;
	$scope.formData.cwbbbsjcsz.sssqq = formData.cwbbbsjcsz.sssqq;
	$scope.formData.cwbbbsjcsz.sssqz = formData.cwbbbsjcsz.sssqz;
	$scope.formData.cwbbbsjcsz.nbsssqq = formData.cwbbbsjcsz.nbsssqq;
	$scope.formData.cwbbbsjcsz.nbsssqz = formData.cwbbbsjcsz.nbsssqz;
	$scope.$apply();
}

function getCwbbbm(sbywbm) {
	//根据业务编码获取包名，兼容其他包里面的财务报表，如四川做的财务报表在cwbbb1（财务报表包1）
	var cwbb = "CWBB_BXLJRQY,CWBB_DBLJRQY,CWBB_YHLJRQY,CWBB_ZQLJRQY,CWBB_CJTJJZZ,CWBB_GTGSH,CWBB_QYKJZD,CWBB_SYDW_KJZD,CWBB_XQY_KJZZ,CWBB_JRKGJTGSLJRQY,CWBB_JRZCGLGSLJRQY,CWBB_MJFYLZZ_KJZD,CWBB_NMZYHZS_KJZD,CWBB_QY_KJZZ_BXGS,CWBB_QY_KJZZ_SYYH,CWBB_QY_KJZZ_YBQY,CWBB_QY_KJZZ_ZQGS,CWBB_QHJT";
	var cwbbb1 = "CWBB_GBSYDWKJZD,CWBB_HYKJZD,CWBB_KXDWKJZD,CWBB_YYKJZD,CWBB_ZXXXKJZD,CWBB_KCSJQYKJZD,CWBB_GDXXKJZD,CWBB_CHSYDWKJZD,CWBB_WHSYDWKJZD,CWBB_TYSYDWKJZD,CWBB_RKHJHSYSYDWKJZD,CWBB_CPJGKJZD,CWBB_QYKJZD_BXZJGS,CWBB_JCYLWSJGKJZD,CWBB_QYKJZD_MHQY,CWBB_WWSYDWKJZD,CWBB_XZDWKJZD,CWBB_DDQYKJZZ,CWBB_QY_KJZZ_DBQY";
	if (cwbb.indexOf(sbywbm) > -1) {
		return "cwbb";
	}
	if (cwbbb1.indexOf(sbywbm) > -1) {
		return "cwbbb1";
	}
	return "cwbb";
}

/**根据URL的参数名获取参数值*/
function getQueryString(name) {
	var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
	var r = parent.window.location.search.substr(1).match(reg);
	if (r != null) {
		return unescape(r[2]);
	}
	return null;
}

function isEmpty(strObj) {
	if (strObj == "" || strObj == null || strObj == undefined) {
		return true;
	}
	return false;
}


/**
 * 财务报表校验是否逾期
 * @param strObj
 * @returns {Boolean}
 */
function saveEvent1() {
	//BJGSCSYTH-182 北京财报增加逾期申报校验
	var cbqxreqUrl = window.location.protocol + '//' + window.location.host + parent.cp;
	var cwqxData = {};
	cwqxData.sid = "Nfzh.SB.CWBB.jsCwbbBsqx";
	cwqxData.bsssqq = parent.formData.cwbbbsjcsz.sssqq;
	cwqxData.bsssqz = parent.formData.cwbbbsjcsz.sssqz;
	cwqxData.bbbsqDm = parent.formData.cwbbbsjcsz.bsqj;
	cwqxData.djxh = parent.formData.extraParam.djNsrxx.djxh;
	cwqxData.gdslxDm = parent.$("#gdslxDm").val();
	cwqxData.swjgDm = parent.formData.extraParam.djNsrxx.zgswjdm;
	$.ajax({
		type: "POST",
		url: cbqxreqUrl + "/nssb/jscwbbSbqx.do",
		dataType: "json",
		contentType: "application/json",
		data: JSON.stringify(cwqxData),
		async: false,
		success: function (data) {
			var result = eval("(" + data + ")");
			//是否成功返回
			var cgbz = result.success;
			//失败
			if(cgbz=="N"){
				//提示错误信息
				var rtnMsg = result.rtnMsg;
				parent.layer.alert(rtnMsg,{title:"提示",icon: 2});
				return;
				
			}else{
				//成功返回,是否逾期标志，已逾期，不能继续申报
				var sfyqbz = result.sfyqbz;
				if(sfyqbz =='Y'){
					var bsqx = result.bsqx;
					var tsmsg = "当前报表报送期为"+bsqx+",您已逾期申报，请前往办税大厅进行申报!";
					//逾期提示
					parent.layer.alert(tsmsg,{title:"提示",icon: 2});
					return;
				}else{
					//未逾期，继续申报,下一步
					saveEvent2();
				}
			}
		}
	});
	
}
